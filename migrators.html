<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Making Migrators &#8212; cf-scripts  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=12dfc556" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Usage Docs" href="usage.html" />
    <link rel="prev" title="Welcome to cf-scripts’s documentation!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="making-migrators">
<h1>Making Migrators<a class="headerlink" href="#making-migrators" title="Link to this heading">¶</a></h1>
<p>Migration is an important part of the regro-cf-autotick-bot’s duties.
Migrations usually change how many feedstocks/packages operate, these can be
as simple as a yaml syntax change, or as complex as moving compiler stacks.
Most migrations are due to a change in the global pinning, as packages change
their pinning, the entire stack which depends directly on that package will
need to be updated.
This document will teach you how to create new migrators.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unless you need to write a custom migrator, you should call for a migration using the <code class="docutils literal notranslate"><span class="pre">conda-forge-pinning-feedstock</span></code></p>
</div>
</div></blockquote>
</section>
<section id="migrating-branches-on-your-feedstock">
<h1>Migrating Branches on Your Feedstock<a class="headerlink" href="#migrating-branches-on-your-feedstock" title="Link to this heading">¶</a></h1>
<p>If you’d like to have the bot apply migrations to branches on your feedstock,
add the following to your <code class="docutils literal notranslate"><span class="pre">conda-forge.yml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">bot</span><span class="p">:</span>
<span class="w">  </span><span class="nt">abi_migration_branches</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.10.x</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">master</span></code> or <code class="docutils literal notranslate"><span class="pre">main</span></code> will always be included.</p>
</section>
<section id="building-a-migration-yaml-using-cfep9">
<h1>Building a Migration YAML Using CFEP9<a class="headerlink" href="#building-a-migration-yaml-using-cfep9" title="Link to this heading">¶</a></h1>
<p>For most migrations a migration can be created by adding a new migration yaml file in the <code class="docutils literal notranslate"><span class="pre">recipe/migrations</span></code> folder of <code class="docutils literal notranslate"><span class="pre">conda-forge-pinning-feedstock</span></code> and issuing a PR.
Once merged the migration will start.
You can copy the <code class="docutils literal notranslate"><span class="pre">recipe/migrations/example.exyaml</span></code> example and modify it similar to the staged-recipes example recipe.
Note that the <code class="docutils literal notranslate"><span class="pre">migration_ts</span></code> is the timestamp of the migration and can be created by copying the result of <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">time;</span> <span class="pre">print(time.time())</span></code> from a python interpreter.</p>
<p>Please see the <a class="reference external" href="https://github.com/conda-forge/conda-forge-enhancement-proposals/blob/main/cfep-09.md#implementation-details">CFEP9 implementation</a> information for the
different kinds of migrations that are available.</p>
</section>
<section id="custom-migrations">
<h1>Custom Migrations<a class="headerlink" href="#custom-migrations" title="Link to this heading">¶</a></h1>
<p>Custom migrators are used when</p>
<ol class="arabic simple">
<li><p>the internals of the conda-forge system (e.g., the various yaml configuration files)
need to be changed</p></li>
<li><p>the migration task falls outside of CFGEP-09 (e.g., renaming a package, swapping
a dependency, etc.)</p></li>
</ol>
<p>To add a custom migration, follow the following steps.</p>
<section id="write-your-custom-migration-class">
<h2>Write your Custom Migration Class<a class="headerlink" href="#write-your-custom-migration-class" title="Link to this heading">¶</a></h2>
<p>Your <code class="docutils literal notranslate"><span class="pre">Migration</span></code> instance should inherit from <code class="docutils literal notranslate"><span class="pre">conda_forge_tick.migrations.core.Migration</span></code>.
You should implement the <code class="docutils literal notranslate"><span class="pre">migrate</span></code> method and override any other methods in order to make
a good looking pull request with a correct change to the feedstock.</p>
</section>
<section id="add-your-migration-to-auto-tick-py">
<h2>Add your <code class="docutils literal notranslate"><span class="pre">Migration</span></code> to <code class="docutils literal notranslate"><span class="pre">auto_tick.py</span></code><a class="headerlink" href="#add-your-migration-to-auto-tick-py" title="Link to this heading">¶</a></h2>
<p>To have the bot run the migration, we need to add the migrator to add it to the
<code class="docutils literal notranslate"><span class="pre">auto_tick</span></code> module.
If the migrator needs no information about the graph (e.g., version bumps), then
it can be added to the <code class="docutils literal notranslate"><span class="pre">MIGRATORS</span></code> list directly.
If the migrator needs graph information (e.g., it runs in topological order), then it
needs to be added by a function (e.g., <code class="docutils literal notranslate"><span class="pre">add_rebuild</span></code>).
This function takes in the list of migrators and the entire package graph.
The job of the function is to pare down the graph to the nodes which need
to be migrated, for instance only packages which require <code class="docutils literal notranslate"><span class="pre">python</span></code>.
This pared-down graph is passed into the migrator, which is then added
to the migrators list.</p>
<p>Once the <code class="docutils literal notranslate"><span class="pre">add_rebuild...</span></code> function is created, it needs to be added to the
<code class="docutils literal notranslate"><span class="pre">initialize_migrators</span></code> function so the migration will go forward.</p>
<p>See the <code class="docutils literal notranslate"><span class="pre">auto_tick.py</span></code> file for example <code class="docutils literal notranslate"><span class="pre">add_rebuild...</span></code> functions.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">cf-scripts</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Making Migrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="#migrating-branches-on-your-feedstock">Migrating Branches on Your Feedstock</a></li>
<li class="toctree-l1"><a class="reference internal" href="#building-a-migration-yaml-using-cfep9">Building a Migration YAML Using CFEP9</a></li>
<li class="toctree-l1"><a class="reference internal" href="#custom-migrations">Custom Migrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#write-your-custom-migration-class">Write your Custom Migration Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-your-migration-to-auto-tick-py">Add your <code class="docutils literal notranslate"><span class="pre">Migration</span></code> to <code class="docutils literal notranslate"><span class="pre">auto_tick.py</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="version_migrator.html">Notes on the <code class="docutils literal notranslate"><span class="pre">Version</span></code> Migrator</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome to cf-scripts’s documentation!</a></li>
      <li>Next: <a href="usage.html" title="next chapter">Usage Docs</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, Conda-forge-tick Development Team.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/migrators.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>